const confirmBtn = document.getElementById('confirmLocationBtn');
const popup = document.getElementById('popup');
const btnConfirm = document.querySelector('.btn-confirm');
const btnClose = document.querySelector('.btn-close');
const locationText = document.getElementById('locationText');
const mapFrame = document.getElementById('mapFrame');

let latitude = null;
let longitude = null;

// ðŸ“ à¸žà¸´à¸à¸±à¸”à¸à¸´à¸ˆà¸à¸£à¸£à¸¡ (à¸•à¸±à¸§à¸­à¸¢à¹ˆà¸²à¸‡: à¸¡.à¸à¸£à¸¸à¸‡à¹€à¸—à¸ž)
const eventLat = 14.072900;
const eventLon = 100.606200;
const allowedRadius = 200; // à¸«à¸™à¹ˆà¸§à¸¢: à¹€à¸¡à¸•à¸£

// ðŸ§® à¸Ÿà¸±à¸‡à¸à¹Œà¸Šà¸±à¸™à¸„à¸³à¸™à¸§à¸“à¸£à¸°à¸¢à¸° (Haversine Formula)
function calculateDistance(lat1, lon1, lat2, lon2) {
  const R = 6371e3; // à¸£à¸±à¸¨à¸¡à¸µà¹‚à¸¥à¸ (à¹€à¸¡à¸•à¸£)
  const Ï†1 = lat1 * Math.PI / 180;
  const Ï†2 = lat2 * Math.PI / 180;
  const Î”Ï† = (lat2 - lat1) * Math.PI / 180;
  const Î”Î» = (lon2 - lon1) * Math.PI / 180;

  const a = Math.sin(Î”Ï† / 2) * Math.sin(Î”Ï† / 2) +
            Math.cos(Ï†1) * Math.cos(Ï†2) *
            Math.sin(Î”Î» / 2) * Math.sin(Î”Î» / 2);
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));

  return R * c; // à¸£à¸°à¸¢à¸°à¸—à¸²à¸‡ (à¹€à¸¡à¸•à¸£)
}

confirmBtn.addEventListener('click', () => {
  if (navigator.geolocation) {
    locationText.textContent = "à¸à¸³à¸¥à¸±à¸‡à¸‚à¸­à¸­à¸™à¸¸à¸à¸²à¸•à¸•à¸³à¹à¸«à¸™à¹ˆà¸‡...";
    navigator.geolocation.getCurrentPosition(
      (position) => {
        latitude = position.coords.latitude;
        longitude = position.coords.longitude;

        locationText.textContent = `à¸•à¸³à¹à¸«à¸™à¹ˆà¸‡à¸‚à¸­à¸‡à¸„à¸¸à¸“: ${latitude.toFixed(6)}, ${longitude.toFixed(6)}`;

        // à¹à¸ªà¸”à¸‡à¹à¸œà¸™à¸—à¸µà¹ˆ
        mapFrame.src = `https://maps.google.com/maps?q=${latitude},${longitude}&hl=th&z=15&output=embed`;

        popup.style.display = 'flex';
      },
      (error) => {
        locationText.textContent = "à¹„à¸¡à¹ˆà¸ªà¸²à¸¡à¸²à¸£à¸–à¸”à¸¶à¸‡à¸•à¸³à¹à¸«à¸™à¹ˆà¸‡à¹„à¸”à¹‰ à¸à¸£à¸¸à¸“à¸²à¸­à¸™à¸¸à¸à¸²à¸•à¸«à¸£à¸·à¸­à¸£à¸µà¹€à¸Ÿà¸£à¸Šà¸«à¸™à¹‰à¸²à¹ƒà¸«à¸¡à¹ˆ";
        popup.style.display = 'flex';
        console.error(error);
      }
    );
  } else {
    alert("à¹€à¸šà¸£à¸²à¸§à¹Œà¹€à¸‹à¸­à¸£à¹Œà¸‚à¸­à¸‡à¸„à¸¸à¸“à¹„à¸¡à¹ˆà¸£à¸­à¸‡à¸£à¸±à¸šà¸à¸²à¸£à¹ƒà¸Šà¹‰à¸‡à¸²à¸™ Geolocation");
  }
});

btnConfirm.addEventListener('click', () => {
  if (latitude !== null && longitude !== null) {
    const distance = calculateDistance(latitude, longitude, eventLat, eventLon);
    if (distance <= allowedRadius) {
      alert(`âœ… à¸¢à¸·à¸™à¸¢à¸±à¸™à¸ªà¸³à¹€à¸£à¹‡à¸ˆ! à¸„à¸¸à¸“à¸­à¸¢à¸¹à¹ˆà¹ƒà¸™à¹€à¸‚à¸•à¸à¸´à¸ˆà¸à¸£à¸£à¸¡ (${distance.toFixed(1)} à¹€à¸¡à¸•à¸£à¸ˆà¸²à¸à¸ˆà¸¸à¸”à¸¨à¸¹à¸™à¸¢à¹Œà¸à¸¥à¸²à¸‡)`);
    } else {
      alert(`âŒ à¸„à¸¸à¸“à¸­à¸¢à¸¹à¹ˆà¸™à¸­à¸à¹€à¸‚à¸•à¸à¸´à¸ˆà¸à¸£à¸£à¸¡ (${distance.toFixed(1)} à¹€à¸¡à¸•à¸£à¸ˆà¸²à¸à¸ˆà¸¸à¸”à¸¨à¸¹à¸™à¸¢à¹Œà¸à¸¥à¸²à¸‡)`);
    }
  } else {
    alert("à¹„à¸¡à¹ˆà¸žà¸šà¸•à¸³à¹à¸«à¸™à¹ˆà¸‡à¸‚à¸­à¸‡à¸„à¸¸à¸“");
  }
  popup.style.display = 'none';
});

btnClose.addEventListener('click', () => {
  popup.style.display = 'none';
});