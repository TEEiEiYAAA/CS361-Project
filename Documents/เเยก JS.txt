const confirmBtn = document.getElementById('confirmLocationBtn');
const popup = document.getElementById('popup');
const btnConfirm = document.querySelector('.btn-confirm');
const btnClose = document.querySelector('.btn-close');
const locationText = document.getElementById('locationText');
const mapFrame = document.getElementById('mapFrame');

let latitude = null;
let longitude = null;

// 📍 พิกัดกิจกรรม (ตัวอย่าง: ม.กรุงเทพ)
const eventLat = 14.072900;
const eventLon = 100.606200;
const allowedRadius = 200; // หน่วย: เมตร

// 🧮 ฟังก์ชันคำนวณระยะ (Haversine Formula)
function calculateDistance(lat1, lon1, lat2, lon2) {
  const R = 6371e3; // รัศมีโลก (เมตร)
  const φ1 = lat1 * Math.PI / 180;
  const φ2 = lat2 * Math.PI / 180;
  const Δφ = (lat2 - lat1) * Math.PI / 180;
  const Δλ = (lon2 - lon1) * Math.PI / 180;

  const a = Math.sin(Δφ / 2) * Math.sin(Δφ / 2) +
            Math.cos(φ1) * Math.cos(φ2) *
            Math.sin(Δλ / 2) * Math.sin(Δλ / 2);
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));

  return R * c; // ระยะทาง (เมตร)
}

confirmBtn.addEventListener('click', () => {
  if (navigator.geolocation) {
    locationText.textContent = "กำลังขออนุญาตตำแหน่ง...";
    navigator.geolocation.getCurrentPosition(
      (position) => {
        latitude = position.coords.latitude;
        longitude = position.coords.longitude;

        locationText.textContent = `ตำแหน่งของคุณ: ${latitude.toFixed(6)}, ${longitude.toFixed(6)}`;

        // แสดงแผนที่
        mapFrame.src = `https://maps.google.com/maps?q=${latitude},${longitude}&hl=th&z=15&output=embed`;

        popup.style.display = 'flex';
      },
      (error) => {
        locationText.textContent = "ไม่สามารถดึงตำแหน่งได้ กรุณาอนุญาตหรือรีเฟรชหน้าใหม่";
        popup.style.display = 'flex';
        console.error(error);
      }
    );
  } else {
    alert("เบราว์เซอร์ของคุณไม่รองรับการใช้งาน Geolocation");
  }
});

btnConfirm.addEventListener('click', () => {
  if (latitude !== null && longitude !== null) {
    const distance = calculateDistance(latitude, longitude, eventLat, eventLon);
    if (distance <= allowedRadius) {
      alert(`✅ ยืนยันสำเร็จ! คุณอยู่ในเขตกิจกรรม (${distance.toFixed(1)} เมตรจากจุดศูนย์กลาง)`);
    } else {
      alert(`❌ คุณอยู่นอกเขตกิจกรรม (${distance.toFixed(1)} เมตรจากจุดศูนย์กลาง)`);
    }
  } else {
    alert("ไม่พบตำแหน่งของคุณ");
  }
  popup.style.display = 'none';
});

btnClose.addEventListener('click', () => {
  popup.style.display = 'none';
});