// ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ API (‡∏Ñ‡∏ß‡∏£‡πÉ‡∏ä‡πâ‡∏ó‡∏µ‡πà‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡πÑ‡∏ü‡∏•‡πå‡∏≠‡∏∑‡πà‡∏ô)
const API_BASE_URL = 'https://mb252cstbb.execute-api.us-east-1.amazonaws.com/prod';

// ‡∏£‡∏≠‡πÉ‡∏´‡πâ‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à‡∏Å‡πà‡∏≠‡∏ô
document.addEventListener('DOMContentLoaded', function() {
    
    // 1. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô (Guard Clause)
    const userData = JSON.parse(localStorage.getItem('userData') || '{}');
    if (!userData.studentId || userData.role !== 'student') {
        window.location.href = "login.html"; // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà ‡∏ô‡∏®. ‡πÉ‡∏´‡πâ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô
        return;
    }
    
    const studentId = userData.studentId;

    // 2. ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡πÅ‡∏ó‡πá‡∏ö
    setupTabs(studentId);

    // 3. ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≠‡∏á‡πÅ‡∏ó‡πá‡∏ö‡πÅ‡∏£‡∏Å (Available) ‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
    loadQuizzes('available', studentId);
});

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Å‡∏≤‡∏£‡∏Ñ‡∏•‡∏¥‡∏Å‡πÅ‡∏ó‡πá‡∏ö
function setupTabs(studentId) {
    const tabButtons = document.querySelectorAll('.tab-btn');
    const availableHeader = document.getElementById('available-header');
    const doneHeader = document.getElementById('done-header');

    tabButtons.forEach(button => {
        button.addEventListener('click', () => {
            tabButtons.forEach(btn => btn.classList.remove('active'));
            button.classList.add('active');

            const filter = button.dataset.filter;

            if (filter === 'available') {
                availableHeader.style.display = 'grid';
                doneHeader.style.display = 'none';
                // ‚òÖ‚òÖ‚òÖ ‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏°‡∏∏‡∏°‡∏ö‡∏ô‡∏Ç‡∏ß‡∏≤‡∏Ç‡∏≠‡∏á‡∏Å‡∏•‡πà‡∏≠‡∏á‡πÄ‡∏ó‡∏≤ "‡πÇ‡∏Ñ‡πâ‡∏á" ‚òÖ‚òÖ‚òÖ
                availableHeader.style.borderRadius = '0 16px 0 0';
            } else {
                availableHeader.style.display = 'none';
                doneHeader.style.display = 'grid';
                // ‚òÖ‚òÖ‚òÖ ‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏°‡∏∏‡∏°‡∏ö‡∏ô‡∏ã‡πâ‡∏≤‡∏¢‡∏Ç‡∏≠‡∏á‡∏Å‡∏•‡πà‡∏≠‡∏á‡πÄ‡∏ó‡∏≤ "‡πÇ‡∏Ñ‡πâ‡∏á" ‚òÖ‚òÖ‚òÖ
                doneHeader.style.borderRadius = '16px 0 0 0';
            }

            loadQuizzes(filter, studentId);
        });
    });
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏•‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
async function loadQuizzes(filter, studentId) {
    
    // üëá ‚òÖ‚òÖ‚òÖ ‡πÅ‡∏Å‡πâ‡πÅ‡∏Ñ‡πà‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ‡∏Ñ‡∏£‡∏±‡∏ö ‚òÖ‚òÖ‚òÖ
    const listContainer = document.getElementById('quiz-list-data'); 
    
    listContainer.innerHTML = '<div class="loading">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</div>'; // ‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î

    try {
        if (filter === 'available') {
            // --- ‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏ó‡∏µ‡πà "‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏´‡πâ‡∏ó‡∏≥" ---
            // (‡πÇ‡∏Ñ‡πâ‡∏î "‡∏™‡∏°‡∏≠‡∏á" ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏™‡πà‡∏á‡∏°‡∏≤)
            // 1. ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤ (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏≠‡∏≤ yearLevel)
            const studentInfo = await fetchStudentInfo(studentId);
            
            // 2. ‡∏î‡∏∂‡∏á‡∏ó‡∏±‡∏Å‡∏©‡∏∞‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö + ‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö)
            const requiredSkills = await fetchRequiredSkills(studentInfo.yearLevel);
            const optionalSkills = await fetchOptionalSkills(studentInfo.yearLevel);
            const allSkills = [...requiredSkills, ...optionalSkills];

            // 3. ‡∏î‡∏∂‡∏á‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏ö‡∏à‡∏≥‡∏ô‡∏ß‡∏ô)
            const activities = await fetchStudentActivities(studentId);
            const activityCount = countActivitiesPerSkill(activities, allSkills);

            // 4. ‡∏î‡∏∂‡∏á‡∏ó‡∏±‡∏Å‡∏©‡∏∞‡∏ó‡∏µ‡πà "‡∏ó‡∏≥‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏ú‡πà‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß" (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏≠‡∏≤‡∏°‡∏≤‡∏Ñ‡∏±‡∏î‡∏≠‡∏≠‡∏Å)
            const passedSkills = await fetchStudentSkills(studentId);
            const passedSkillIds = new Set(passedSkills.map(s => s.skillId));
            
            // 5. ‡∏Å‡∏£‡∏≠‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ó‡∏±‡∏Å‡∏©‡∏∞‡∏ó‡∏µ‡πà "‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏™‡∏≠‡∏ö"
            // (‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏ñ‡∏∂‡∏á‡πÄ‡∏Å‡∏ì‡∏ë‡πå AND ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏Ñ‡∏¢‡∏™‡∏≠‡∏ö‡∏ú‡πà‡∏≤‡∏ô)
            const availableQuizzes = allSkills.filter(skill => {
                const count = activityCount[skill.skillId] || 0;
                const required = skill.requiredActivities || 3;
                const hasPassed = passedSkillIds.has(skill.skillId);
                
                return (count >= required) && !hasPassed;
            });
            
            displayAvailableQuizzes(availableQuizzes);

        } else if (filter === 'done') {
            // --- ‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏ó‡∏µ‡πà "‡∏ó‡∏≥‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß" ---
            // ‡∏î‡∏∂‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ó‡∏±‡∏Å‡∏©‡∏∞‡∏ó‡∏µ‡πà‡∏™‡∏≠‡∏ö‡∏ú‡πà‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß‡∏à‡∏≤‡∏Å API
            const doneQuizzes = await fetchStudentSkills(studentId);
            displayDoneQuizzes(doneQuizzes);
        }

    } catch (error) {
        console.error('Error loading quizzes:', error);
        
        // ‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ 
        // ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡πÄ‡∏£‡∏≤‡πÅ‡∏Å‡πâ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ listContainer ‡∏Ç‡πâ‡∏≤‡∏á‡∏ö‡∏ô‡πÅ‡∏•‡πâ‡∏ß
        listContainer.innerHTML = '<div class="error-message">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>';
    }
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏ó‡∏µ‡πà "‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏´‡πâ‡∏ó‡∏≥"
function displayAvailableQuizzes(quizzes) {
    const container = document.getElementById('quiz-list-data'); // ‚òÖ ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢
    if (quizzes.length === 0) {
        container.innerHTML = '...'; // (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°)
        return;
    }

    let html = ''; // ‚òÖ‚òÖ‚òÖ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏î‡πâ‡∏ß‡∏¢‡∏Ñ‡πà‡∏≤‡∏ß‡πà‡∏≤‡∏á (‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á header) ‚òÖ‚òÖ‚òÖ

    quizzes.forEach(skill => {
        html += `
            <div class="quiz-data-row">
                <span>${skill.name || '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏±‡∏Å‡∏©‡∏∞'}</span>
                <span>${skill.description || '‡∏ó‡∏±‡∏Å‡∏©‡∏∞‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Å‡∏•‡∏≤‡∏á'}</span>
                <span>${skill.PLO || 'PL01'}</span>
                <div class="quiz-action">
                    <a href="quiz.html?skillId=${skill.skillId}" class="quiz-start-btn">
                        ‡∏Å‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ó‡∏≥‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö
                    </a>
                </div>
            </div>
        `;
    });
    container.innerHTML = html;
}

function displayDoneQuizzes(quizzes) {
    const container = document.getElementById('quiz-list-data'); // ‚òÖ ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢
    if (quizzes.length === 0) {
        container.innerHTML = '...'; // (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°)
        return;
    }

    let html = ''; // ‚òÖ‚òÖ‚òÖ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏î‡πâ‡∏ß‡∏¢‡∏Ñ‡πà‡∏≤‡∏ß‡πà‡∏≤‡∏á (‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á header) ‚òÖ‚òÖ‚òÖ

    quizzes.forEach(skill => {
        html += `
            <div class="quiz-data-row done">
                <span>${skill.skillName || '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏±‡∏Å‡∏©‡∏∞'}</span>
                <span>${skill.PLO || 'PL01'}</span>
                <td><span class="score-badge">‡∏ú‡πà‡∏≤‡∏ô ${skill.FinalScore || 80} ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</span></td>
                <span>${formatDate(skill.completedDate)}</span>
            </div>
        `;
    });
    container.innerHTML = html;
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏ó‡∏µ‡πà "‡∏ó‡∏≥‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß"
function displayDoneQuizzes(quizzes) {
    const container = document.getElementById('quiz-list');
    if (quizzes.length === 0) {
        container.innerHTML = '<div class="empty-message">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡∏ú‡πà‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß</div>';
        return;
    }

    // ‡∏™‡∏£‡πâ‡∏≤‡∏á Header ‡∏Ç‡∏≠‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á
    let html = `
        <div class="quiz-header-row">
            <span>‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</span>
            <span>‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ (PLOs)</span>
            <span>‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</span>
            <span>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ú‡πà‡∏≤‡∏ô</span>
        </div>
    `;

    // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏ñ‡∏ß‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
    quizzes.forEach(skill => {
        html += `
            <div class="quiz-data-row done">
                <span>${skill.skillName || '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏±‡∏Å‡∏©‡∏∞'}</span>
                <span>${skill.PLO || 'PL01'}</span>
                <td><span class="score-badge">‡∏ú‡πà‡∏≤‡∏ô ${skill.FinalScore || 80} ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</span></td>
                <span>${formatDate(skill.completedDate)}</span>
            </div>
        `;
    });
    container.innerHTML = html;
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô Logout (‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏∏‡πà‡∏°‡πÉ‡∏ô Header)
function logout() {
    const confirmLogout = confirm('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?');
    if (confirmLogout) {
        localStorage.removeItem('userData');
        localStorage.removeItem('token');
        window.location.href = "login.html";
    }
}